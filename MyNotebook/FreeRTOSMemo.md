---
title: "FreeRTOS 評価ノート"
layout: "post"
date: 2019-10-21
author: Hattori, Hiroki
---

## Binary Semaphore

　Counting SemaphoreとMutexは取得されていない状態で作成される。だが、
Binary Semaphoreは作成直後はTakeされた状態で作成される。つまり、最初から
リーソスが枯渇した状態になっているので、まずGiveしなくてはならない。


## StreamBuffer

### xStreamBufferReset

　ちょっと古いバージョンだと、静的確保したStreamBufferをリセットすると
Deleteの時にクラッシュする。

　2019-11-21現在のバージョンでは修正されている。



## vTaskAbortDelay

　時間待ちをしているタスクの待ちを強制解除させるAPI。ただし、高優先度のタスクの
待ちを解除してもプリエンプトされない。


## EventFlag

### フラグは24ビットしか使えない。

　引数は32ビットの型を使っているが、上位8ビットはカーネルが使っているので
イベントフラグとしては24ビットしか使えない。

　他のRTOSからポーティングする時に注意。


### Delete

　動的生成したEventFlagをDeleteすると、スケジューラをサスペンドしたままでfree()
を呼び出そうとする。このためヒープのロックにmutex/semaphoreを使っていると
ロックできずにクラッシュする。

　newlibのコールバックを使ってヒープの排他を行おうとすると、mutex/semaphoreを
使うとロックできないのでジャイアントロックを使うしかない。スケジューラをネスト
してロックできるようになっていれば致命的な問題は無いのだが…

　付属のheap?.cを見ても、ヒープはジャイアントロックで排他する事を前提にしている
らしい。パッチを送っても、そもそも不具合として認識してもらえなかった。



